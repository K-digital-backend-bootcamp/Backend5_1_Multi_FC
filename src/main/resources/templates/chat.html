<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTI FC - 실시간 채팅</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* [기존 스타일 유지] */
        .chat-main {
            padding-top: 70px;
            display: flex;
            min-height: 100vh;
            background-color: #f7f7f7;
            position: relative;
            overflow-x: hidden;
            transition: all 0.3s ease-in-out;
        }
        .chat-sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        .chat-content-area {
            flex-grow: 1;
            background: #fff;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease-in-out;
            min-width: 0;
        }

        /* 핵심 CSS: 사이드바가 열릴 때 메인 콘텐츠를 밀어냅니다. */
        .chat-main.sidebar-open {
            margin-right: 280px;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }

        /* ★채팅 유형 탭 버튼 스타일 (깔끔한 글씨 밑줄 형식)★ */
        .chat-type-tabs {
            display: flex;
            justify-content: space-around;
            padding: 10px 0 0 0;
            margin-bottom: 0;
            border-bottom: 1px solid #eee;
        }
        .chat-type-tabs button {
            flex-grow: 1;
            padding: 10px 5px;
            margin: 0;
            background: none !important;
            border: none !important;
            border-radius: 0 !important;
            font-size: 14px;
            font-weight: 600;
            color: #999;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            outline: none;
        }
        .chat-type-tabs button.active {
            color: #6c5ce7;
            border-bottom-color: #6c5ce7;
        }
        .chat-type-tabs button:hover:not(.active) {
            color: #2c3e50;
            background-color: transparent;
        }


        /* 채팅방 목록 */
        .room-list-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px 15px 20px;
            border-bottom: 1px solid #f7f7f7;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .room-item:hover, .room-item.active {
            background-color: #f0f0f0;
        }
        .room-info {
            flex-grow: 1;
            min-width: 0;
            padding-right: 10px;
        }
        .room-name {
            font-weight: 600;
            color: #2c3e50;
        }
        .last-message {
            font-size: 13px;
            color: #888;
            margin-top: 4px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* 삭제 버튼 스타일 */
        .delete-room-btn {
            background: none;
            border: none;
            color: #e74c3c;
            font-size: 15px;
            cursor: pointer;
            flex-shrink: 0;
            opacity: 0.7;
            padding: 5px;
        }
        .delete-room-btn:hover {
            opacity: 1;
        }

        /* 채팅방 상세 */
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f7f7f7;
        }
        .chat-input-area {
            border-top: 1px solid #ddd;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            background: white;
        }
        .chat-input-area input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 15px;
        }
        .chat-input-area button {
            background-color: #6c5ce7;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .chat-input-area button:hover {
            background-color: #8e44ad;
        }

        /* 메시지 버블 스타일 */
        .message-bubble {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        .message-bubble.mine {
            justify-content: flex-end;
        }
        .message-bubble.mine .message-content {
            background-color: #ffe500;
            color: #191919;
            border-radius: 15px 15px 0 15px;
        }
        .message-bubble.other {
            justify-content: flex-start;
        }
        .message-bubble.other .message-content {
            background-color: white;
            color: #333;
            border-radius: 15px 15px 15px 0;
            border: 1px solid #ddd;
        }
        .message-text {
            padding: 10px 15px;
            max-width: 70%;
            word-wrap: break-word;
            font-size: 15px;
        }
        .message-meta {
            font-size: 11px;
            color: #888;
            align-self: flex-end;
            margin: 0 5px;
        }

        /* 룸이 선택되지 않았을 때 */
        #chat-welcome-message {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: #999;
            height: 100%;
            text-align: center;
        }
        #current-chat-room {
            display: none;
            flex-direction: column;
            position: relative;
            height: 100%;
            overflow: hidden; /* 인라인 프로필이 벗어나지 않도록 */
        }

        /* 상태 메시지 */
        #connection-status {
            position: absolute;
            top: 70px;
            left: 0;
            width: 100%;
            background-color: #f0f0f0;
            color: #e74c3c;
            padding: 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            z-index: 990;
            display: none;
        }

        /* ★참여자 목록 사이드바 스타일★ */
        #participant-sidebar {
            position: fixed;
            top: 70px;
            right: 0;
            width: 280px;
            height: calc(100vh - 70px);
            background: white;
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ddd;
        }
        #participant-sidebar.open {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #555;
        }
        .participant-list-container {
            flex-grow: 1;
            padding: 10px 0;
        }

        /* 참여자 항목 스타일 개선 */
        .participant-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #f7f7f7;
            cursor: pointer;
        }
        .participant-item:hover {
            background-color: #fcfcfc;
        }
        .participant-icon-wrapper {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .participant-icon-wrapper i {
            font-size: 16px;
            color: #6c5ce7;
            margin: 0;
        }
        .participant-details {
            display: flex;
            flex-direction: column;
            line-height: 1.3;
        }
        .participant-name {
            font-size: 15px;
            color: #333;
            font-weight: 500;
        }
        .participant-role-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 5px;
            margin-left: 5px;
            color: white;
            white-space: nowrap;
        }
        .role-admin { background-color: #6c5ce7; }
        .role-host { background-color: #e74c3c; }
        .role-me { background-color: #3498db; }

        /* 모바일 대응 */
        @media (max-width: 900px) {
            .chat-main.sidebar-open {
                width: 100%;
                margin-right: 0;
            }
            #participant-sidebar {
                width: 100%;
                height: calc(100vh - 70px);
            }
        }

        /* ★모달 스타일★ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s;
            position: relative;
        }
        .modal-overlay.open .modal-content {
            transform: translateY(0);
        }
        .modal-content h2 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #6c5ce7;
            padding-bottom: 10px;
        }
        .modal-content p {
            font-size: 15px;
            color: #555;
            margin-bottom: 10px;
        }
        .modal-content strong {
            color: #6c5ce7;
            margin-left: 5px;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-actions button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-cancel {
            background: #f0f0f0;
            color: #555;
            border: 1px solid #ddd;
        }
        .btn-create {
            background: #6c5ce7;
            color: white;
            border: none;
        }

        /* 새 채팅 모달 전용 입력 필드 스타일 */
        #new-chat-modal .modal-content input,
        #new-chat-modal .modal-content select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-size: 15px;
        }

        /* ★친구 초대 모달 목록 스타일 */
        .invite-friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f7f7f7;
            cursor: pointer;
        }
        .invite-friend-item:hover {
            background-color: #fafafa;
        }
        .invite-friend-item.selected {
            background-color: #e6e6ff; /* 연한 보라색 배경 */
        }
        .invite-friend-item span {
            font-size: 15px;
            color: #333;
        }
        .friend-status {
            font-size: 12px;
            color: #28a745; /* 온라인 색상 */
            margin-left: 10px;
        }
        .friend-status.offline {
            color: #999;
        }
        .friend-checkbox {
            transform: scale(1.2);
            accent-color: #6c5ce7;
        }

        /* ★초대 모달 내 버튼 */
        #invite-modal .modal-content button {
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: 600;
        }
        #final-invite-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        /* ★★★ 최종 수정: 인라인 프로필 상세 정보 스타일 (버그 해결 및 UI 확정) ★★★ */
        .inline-profile-detail {
            /* ⭐⭐⭐ 위치 조정: FIXED + 우측 참여자 사이드바 옆에 나오도록 ⭐⭐⭐ */
            position: fixed;
            top: 100px;
            right: 280px; /* 참여자 사이드바 너비만큼 왼쪽으로 띄우기 (280px) */
            width: 200px; /* 창 크기 조정 */
            height: auto;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;

            /* ⭐⭐⭐ 초기 숨김 상태 (JS에서 display:none 제어) ⭐⭐⭐ */
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: none; /* ⭐⭐ 초기 렌더링 시 아예 숨김 ⭐⭐ */
            flex-direction: column;
            z-index: 9999;
            border: 1px solid #ddd;
        }

        /* 창이 열렸을 때 (현재 위치(right: 280px)로 이동) */
        .inline-profile-detail.open {
            transform: translateX(0%); /* X축 이동 0% = right: 280px 위치에 표시 */
            display: flex; /* ⭐⭐ 열릴 때만 보이게 설정 ⭐⭐ */
        }

        .inline-profile-detail .close-profile-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #555;
        }
        .profile-detail-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid #6c5ce7;
        }
        .profile-info-content h3 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .profile-meta-info p {
            font-size: 12px;
            color: #555;
            margin-bottom: 4px;
        }
        .profile-meta-info strong {
            font-size: 13px;
        }
        .chat-one-on-one-btn, .send-friend-request-btn {
            padding: 8px 10px;
            margin-top: 8px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
            font-size: 13px;
        }
        /* 프로필 상세 창이 열렸을 때 메시지 영역을 밀어냅니다. (fixed position이라 필요 없음) */
        .chat-content-area.profile-open {
            padding-left: 0;
        }
        /* ⭐⭐ 보강: 채팅방 상세 정보 (인원/유형) 헤더 스타일 ⭐⭐ */
        .room-title-wrapper {
            display: flex;
            align-items: center;
        }
        .room-status-info {
            font-size: 13px;
            font-weight: 500;
            color: #6c5ce7;
            margin-left: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .room-status-info .fa-lock { color: #e74c3c; } /* 1:1 채팅 아이콘 색상 */
        .room-status-info .fa-users { color: #6c5ce7; } /* 그룹 채팅 아이콘 색상 */
        /* ⭐⭐ 보강 끝 ⭐⭐ */
        /* ⭐⭐ 보강: 안 읽은 메시지 뱃지 및 인원 수 표시를 위한 컨테이너 ⭐⭐ */
        .room-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .unread-badge {
            background-color: #e74c3c;
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 10px;
            padding: 3px 8px;
            flex-shrink: 0;
            min-width: 24px;
            text-align: center;
        }
        /* ⭐⭐ 보강 끝 ⭐⭐ */

        /* ★추가: 친구 초대 버튼 스타일 개선 */
        .invite-action-btn {
            padding: 15px 25px !important; /* 내부 패딩 증가로 높이/크기 증가 */
            font-size: 16px !important; /* 폰트 크기 유지 */
            font-weight: 700 !important;
            cursor: pointer !important; /* 마우스 포인터 추가 */
            transition: background-color 0.3s, transform 0.2s;
        }
        .invite-action-btn:hover {
            transform: translateY(-1px);
            background-color: #27ae60 !important; /* hover 색상 변경 */
        }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div> <div class="header-icons">
    <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;"> <i class="fas fa-user-circle"></i> </button>
    <div id="profile-menu" class="user-menu"></div>
    <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
</div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> 메인 (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> 구장검색</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> 커뮤니티</a></li>
            <li id="nav-chat-link-li"><a href="/chat" class="active"><i class="fas fa-comments"></i> 실시간채팅</a></li>
        </ul>
    </nav>
</header>

<div id="connection-status">
    WebSocket 연결 중... 서버가 준비되면 자동으로 연결됩니다.
</div>

<main id="chat-main-wrapper" class="chat-main">
    <div class="chat-sidebar">
        <div class="chat-header">
            채팅 목록
            <button id="new-chat-btn" onclick="openNewChatModal(true)" style="background:none; border:none; color:#6c5ce7; font-size:16px; cursor:pointer;" title="새 채팅 시작">
                <i class="fas fa-plus-circle"></i>
            </button>
        </div>

        <div id="chat-type-tabs" class="chat-type-tabs">
            <button data-type="public">전체 채팅</button>
            <button data-type="group">그룹 채팅</button>
            <button data-type="one-on-one">1:1 채팅</button>
        </div>

        <div id="room-list-container" class="room-list-container">
        </div>
    </div>

    <div class="chat-content-area">
        <div id="chat-welcome-message">
            <p>채팅 목록에서 방을 선택해주세요.</p>
        </div>

        <div id="current-chat-room">
            <div id="chat-room-header" class="chat-header">

                <div class="room-title-wrapper">
                    <span id="room-title">채팅방 제목</span>
                    <div id="room-status-display" class="room-status-info">
                        <span id="room-type-icon"></span>
                        <span id="room-participant-count">0/0</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="openParticipantList()" style="background:none; border:none; color:#6c5ce7; font-size:18px; cursor:pointer;" title="참여자 목록">
                        <i class="fas fa-users"></i>
                    </button>
                    <button id="leave-room-btn" style="background:none; border:none; color:#e74c3c; font-size:18px; cursor:pointer; display:none;" title="채팅방 나가기">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <div id="inline-profile-detail" class="inline-profile-detail">
                <button class="close-profile-btn" onclick="openInlineProfileDetail(false)">&times;</button>
                <div class="profile-info-content" style="text-align: center;">
                    <div style="margin-bottom: 10px; padding-top: 5px;">
                        <img id="profile-img-detail" src="/images/default-profile.png" alt="프로필 이미지" class="profile-detail-img">
                        <h3 id="profile-nickname-detail">닉네임</h3>
                    </div>
                    <div class="profile-meta-info" style="border-top: 1px solid #eee; padding-top: 10px;">
                        <p style="font-weight: 500;">장소: <strong id="profile-location-detail">...</strong></p>
                        <p style="font-weight: 500;">포지션: <strong id="profile-position-detail">...</strong></p>
                    </div>
                    <button class="chat-one-on-one-btn profile-action-button" id="profile-chat-btn">1:1 채팅하기</button>
                    <button class="send-friend-request-btn profile-action-button" id="profile-friend-btn">친구 요청</button>
                </div>
            </div>

            <div id="chat-messages-container" class="chat-messages">
            </div>

            <div class="chat-input-area">
                <input type="text" id="message-input" placeholder="메시지를 입력하세요..." onkeypress="if(event.keyCode===13) sendMessage()" maxlength="500">
                <button onclick="sendMessage()">전송</button>
            </div>
        </div>

    </div>
</main>

<div id="participant-sidebar">
    <div class="sidebar-header">
        <span id="sidebar-room-name">참여자 목록</span>
        <button class="sidebar-close-btn" onclick="openParticipantList(false)">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="participant-list-container" class="participant-list-container">
    </div>
    <div style="padding: 15px; border-top: 1px solid #eee;">
        <button class="btn-create invite-action-btn" style="width: 100%;" onclick="openInviteModal()">
            <i class="fas fa-user-plus"></i> 친구 초대하기
        </button>
    </div>
</div>

<div id="new-chat-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>새 채팅방 시작</h2>

        <label for="new-chat-type">채팅방 유형 선택</label>
        <select id="new-chat-type" onchange="updateNewChatForm(this.value)">
            <option value="one-on-one" selected>1:1 채팅</option>
            <option value="group">그룹 채팅</option>
            <option value="public">전체 채팅 (전체 공개)</option>
        </select>

        <div id="max-participants-group" style="display: none;">
            <label for="new-chat-max-participants" style="margin-top: 10px;">최대 참여 인원 (그룹 채팅)</label>
            <input type="number" id="new-chat-max-participants" min="3" max="50" value="10">
        </div>
        <label for="new-chat-title" style="margin-top: 10px;">채팅방 이름</label>
        <input type="text" id="new-chat-title" placeholder="채팅방 제목을 입력하세요">

        <div id="recipient-input-group">
            <label for="new-chat-recipient" style="margin-top: 10px;">상대방 닉네임 (1:1 채팅)</label>
            <input type="text" id="new-chat-recipient" placeholder="채팅할 상대방의 닉네임을 입력하세요">
            <p id="chat-form-info" style="font-size: 13px; color: #777; margin-bottom: 20px;">1:1 채팅은 상대방 닉네임이 필수입니다.</p>
        </div>


        <div class="modal-actions">
            <button class="btn-cancel" onclick="openNewChatModal(false)">취소</button>
            <button class="btn-create" onclick="createNewChat()">채팅 시작</button>
        </div>
    </div>
</div>

<div id="profile-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h2 id="profile-username-title">사용자 프로필</h2>
        <div id="profile-details-content">
            <p>닉네임: <strong id="profile-nickname">...</strong></p>
            <p>포지션: <strong id="profile-position">...</strong></p>
            <p>지역: <strong id="profile-location">...</strong></p>
            <p style="margin-top: 15px; font-size: 14px; color: #e74c3c;">
                (실제 DB 정보 연동 필요)
            </p>
        </div>
        <div class="modal-actions" style="justify-content: center;">
            <button class="btn-cancel" onclick="openProfileModal(false)">닫기</button>
        </div>
    </div>
</div>

<div id="invite-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>친구 초대</h2>
        <p id="invite-room-info">현재 방: <strong id="invite-room-name">...</strong> (인원 제한: <span id="invite-count-info">...</span>)</p>

        <div id="friend-list-to-invite">
        </div>

        <div class="modal-actions" style="justify-content: space-between;">
            <p style="font-size: 14px; color: #555; margin: 0; align-self: center;">
                <span id="selected-invite-count">0</span>명 선택됨
            </p>
            <div>
                <button class="btn-cancel" onclick="openInviteModal(false)">취소</button>
                <button class="btn-create" id="final-invite-btn" onclick="sendInvite()">초대하기</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    // --- (★공통★) 메뉴 토글 및 인증 로직 ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navLoginLink = document.querySelector('#main-menu a[href="/login"]');
    const navLogoutLink = document.querySelector('#main-menu ul li:last-child');
    // ... (이하 공통 로직 유지) ...

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            if (profileMenu) profileMenu.classList.remove('show');
        });
    }

    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            if (mainMenu) mainMenu.classList.remove('show');
        });
    }
    // ... (이하 공통 로직 유지) ...


    // ===========================================
    // 챗 클라이언트 로직 (WebSocket/STOMP)
    // ===========================================

    //webSocket/Stomp
    let stompClient = null;
    let currentRoomId = null;

    //사용자 정보
    let myUserId = null;
    let myUsername = null;

    //DOM 요소
    const chatContainer = document.getElementById('chat-messages-container');
    const inputArea = document.getElementById('message-input');
    const roomTitleElement = document.getElementById('room-title');
    const connectionStatus = document.getElementById('connection-status');
    const roomListContainer = document.getElementById('room-list-container');
    const chatTypeTabs = document.getElementById('chat-type-tabs');
    const participantSidebar = document.getElementById('participant-sidebar');
    const participantListContainer = document.getElementById('participant-list-container');
    const chatMainWrapper = document.getElementById('chat-main-wrapper'); // 메인 wrapper

    //modal 요소
    const newChatModal = document.getElementById('new-chat-modal'); // 새 채팅 모달
    const profileModal = document.getElementById('profile-modal'); // ★프로필 모달
    const inviteModal = document.getElementById('invite-modal'); // ★초대 모달
    const friendListToInvite = document.getElementById('friend-list-to-invite'); // ★초대 목록 컨테이너
    const selectedInviteCountElement = document.getElementById('selected-invite-count'); // ★선택 인원 수 표시
    let selectedInvitees = new Set(); // ★선택된 친구 Set

    // inline 프로필
    const inlineProfileDetail = document.getElementById('inline-profile-detail');
    const chatContentArea = document.querySelector('.chat-content-area');
    const roomStatusDisplay = document.getElementById('room-status-display');
    const roomParticipantCount = document.getElementById('room-participant-count');
    const roomTypeIcon = document.getElementById('room-type-icon');
    const profileChatBtn = document.getElementById('profile-chat-btn');
    const profileFriendBtn = document.getElementById('profile-friend-btn');

    // ★모달 내 입력 요소
    const newChatTypeSelect = document.getElementById('new-chat-type');
    const newChatTitleInput = document.getElementById('new-chat-title');
    const newChatRecipientInput = document.getElementById('new-chat-recipient');
    const recipientInputGroup = document.getElementById('recipient-input-group');
    const chatFormInfo = document.getElementById('chat-form-info');

    const RECONNECT_INTERVAL = 5000;
    let currentChatType = 'public'; // ★기본값 public으로 설정 (HTML 탭과 일치)
    let selectedInvites = new Set();

    //JWT 사용자 정보 추출
    function initUserInfo() {
        const token = localStorage.getItem('accessToken');
        if(!token) {
            alert("로그인이 필요합니다.");
            location.href = "/login";
            return;
        }

        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            myUserId = payload.userId || payload.sub;
            myUsername = payload.username;

            console.log('사용자 정보', { myUserId, myUsername });
        } catch (e) {
            console.error('JWT 파싱 실패:' , e);
            alert("인증 정보가 올바르지 않습니다. 다시 로그인 해주세요.");
            localStorage.removeItem('accessToken');
            location.href = "/login";
        }
    }

    //WebSocket 연결 관리
    function updateStatus(message, isError = true) {
        connectionStatus.textContent = message;
        connectionStatus.style.display = 'block';
        connectionStatus.style.backgroundColor = isError ? '#ffe3e3' : '#e6ffed';
        connectionStatus.style.color = isError ? '#c0392b' : '#28a745';

        if (!isError) {
            setTimeout(() => {
                connectionStatus.style.display = 'none';
            }, 3000);
        } else {
            connectionStatus.style.display = 'none';
            console.error("WebSocket 연결 실패. 5초 후 재시도합니다.");
        }
    }

    function connect() {
        if (stompClient && stompClient.connected) {
            console.log('Already connected.');
            return;
        }

        updateStatus("WebSocket 연결 시도 중...", true);

        const socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        const token = localStorage.getItem('accessToken');
        const header = token ? { Authorization: `Bearer ${token}` } : {};

        stompClient.connect(header, onConnected, onError);
    }

    function onConnected() {
        console.log('WebSocket 연결 성공.');
        updateStatus("✅ 실시간 채팅 서버에 연결되었습니다.", false);

        if (currentRoomId) {
            subscribeToRoom(currentRoomId);
        }
    }

    function onError(error) {
        console.error('WebSocket 연결 오류: 재연결 시도', error);
        connectionStatus.style.display = 'none';

        if (stompClient && stompClient.ws && stompClient.ws.readyState === WebSocket.OPEN) {
            stompClient.disconnect(() => {
                stompClient = null;
                setTimeout(connect, RECONNECT_INTERVAL);
            });
        } else {
            stompClient = null;
            setTimeout(connect, RECONNECT_INTERVAL);
        }
    }

    //유틸리티 함수
    async function fetchUserIdByNickname(nickname) {
        const token = localStorage.getItem('accessToken');
        const response = await fetch(`/api/users/search?nickname=${encodeURIComponent(nickname)}`, {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });

        if(!response.ok) throw new Error(`사용자 "${nickname}"를 찾을 수 없습니다.`);

        const user = await response.json();
        return user.userId;
    }

    async function fetchUserIdsByNicknames(nicknames) {
        const userIds = [];
        for (const nickname of nicknames) {
            try{
                userIds.push(await fetchUserIdByNickname(nickname));
            } catch(e) {
                console.error(`${nickname} 조회 실패:`,e);
            }
        }
        return userIds;
    }

    function convertToBackendRoomType(frontendType){
        const typeMap = {
            'public': null,
            'group': '그룹',
            'one-on-one':'1대1'
        };
        return typeMap[frontendType];
    }

    function convertToFrontendRoomType(backendType){
        const typeMap = {
            '그룹': 'group',
            '1대1': 'one-on-one'
        };
        return typeMap[backendType] || 'public';
    }

    //메세지 관련
    function subscribeToRoom(roomId) {
        if (stompClient && stompClient.connected) {
            stompClient.subscribe(`/topic/chatroom/${roomId}`, onMessageReceived);
            console.log(`Room ${roomId} 구독 시작.`);
        }
    }

    function onMessageReceived(payload) {
        try {
            const message = JSON.parse(payload.body);
            console.log("수신된 메세지:", message);


            displayMessage({
                sender : message.senderNickname,
                content : message.content,
                timestamp : formatTimestamp(message.sentAt || new Date())
            });
        } catch (e) {
            console.log('메세지 파싱 오류:',e);
        }
    }
    function formatTimestamp(sentAt) {
        return new Date(sentAt).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // 메시지 전송 로직 (전송 후 화면 표시)
    function sendMessage() {
        const messageContent = inputArea.value.trim();

        if(!messageContent) return;

        if(!currentRoomId){
            alert("채팅방을 먼저 선택해주세요.");
            return;
        }

        if(!stompClient || !stompClient.connected){
            alert("❌ 채팅 서버에 연결되어 있지 않습니다. 잠시 후 재시도 해주세요.");
            return;
        }

        const chatMessage = {
            roomId: currentRoomId,
            sender: myUserId,
            senderNickname: myUsername,
            content: messageContent,
        };

        // 1. 서버로 전송 (실시간 웹소켓)
        stompClient.send(`/app/chatroom/${currentRoomId}/send`, {}, JSON.stringify(chatMessage));

        // 2. 입력 필드 초기화
        inputArea.value = '';

        // 3. 화면에 즉시 표시 (UX 개선)
        displayMessage({
            sender: myUsername,
            content: messageContent,
            timestamp: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
        });

        // 4. 목록의 마지막 메시지 업데이트
        updateLastMessage(currentRoomId, messageContent);

    }


    // 새로운 함수: 채팅 목록의 마지막 메시지 업데이트
    function updateLastMessage(roomId, content) {
        const roomItem = document.querySelector(`.room-item[data-room-id="${roomId}"]`);
        if (roomItem) {
            const lastMessageDiv = roomItem.querySelector('.last-message');
            if (lastMessageDiv) {
                const preview = (content.length > 30 ? content.substring(0, 30) + '...' : content);
                lastMessageDiv.textContent = `나: ${preview}`;
            }
        }
    }

    function displayMessage(message) {
        const isMine = message.sender === myUsername;
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble ' + (isMine ? 'mine' : 'other');

        let senderName = isMine ? '' : message.sender;
        if (message.sender.includes("(운영진)") || message.sender.includes("관리자")) {
            senderName = `<span style="font-weight: 700; color: #6c5ce7;">${senderName}</span>`;
        } else if (message.sender.includes("(방장)")) {
            senderName = `<span style="font-weight: 700; color: #e74c3c;">${senderName}</span>`;
        }

        const meta = `<div class="message-meta">${message.timestamp}</div>`;
        const content = `<div class="message-content message-text">${senderName}${!isMine && senderName ? ': ' : ''}${message.content}</div>`;

        if (isMine) {
            bubble.innerHTML = meta + content;
        } else {
            bubble.innerHTML = content + meta;
        }

        chatContainer.appendChild(bubble);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ⭐⭐ 보강: loadRoomList 함수 (안 읽은 메시지 뱃지 추가) ⭐⭐
    async function loadRoomList(type) {
        currentChatType = type;
        roomListContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">로딩 중...</div>';

        try {
            const token = localStorage.getItem('accessToken');

            let rooms = [];

            if (type === 'public') {
                const oneToOneResponse = await fetch('/chatroom?type=1대1, {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const groupResponse = await fetch('/chatroom?type=그룹',{
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if(!oneToOneResponse.ok || !groupResponse.ok){
                    throw new Error('채팅방 목록 조회 실패');
                }

                const oneToOneRooms = await oneToOneResponse.json();
                const groupRooms = await groupResponse.json();

                rooms = [...oneToOneRooms, ...groupRooms];
            } else {
                const backendType = convertToBackendRoomType(type);

                const response = await fetch(`/chatroom?type=${backendType}`,{
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if(!response.ok){
                    throw new Error('채팅방 목록 조회 실패');
                }

                rooms = await response.json();
            }
            renderRoomList(rooms);
        } catch (error) {
            console.error('채팅방 목록 로드 실패:', error);
            roomListContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#e74c3c;">채팅방을 불러오지 못했습니다.</div>';
        }
    }

    // 렌더링 로직 분리
    function renderRoomList(rooms) {
        roomListContainer.innerHTML = '';

        if (rooms.length === 0) {
            roomListContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: #999;">현재 ${currentChatType} 유형의 채팅방이 없습니다.</div>`;
            if (!currentRoomId || !rooms.find(room => room.roomId === currentRoomId)) {
                currentRoomId = null;
                document.getElementById('current-chat-room').style.display = 'none';
                document.getElementById('chat-welcome-message').style.display = 'flex';
                roomStatusDisplay.style.display = 'none';
            }
            return;
        }

        rooms.forEach( room => {
            const isActive = room.roomId === currentRoomId;
            const item = document.createElement('div');
            item.className = 'room-item' + (isActive ? ' active' : '');
            item.dataset.roomId = room.roomId;

            let typeIcon = '';
            if (room.roomType === '1대1') {
                typeIcon = '<i class="fas fa-user" style="color:#6c5ce7; margin-right:5px;"></i>';
            } else if (room.roomType === '그룹') {
                typeIcon = '<i class="fas fa-users" style="color:#00b894; margin-right:5px;"></i>';
            }

            // ★채팅방 정보 영역
            const roomInfo = document.createElement('div');
            roomInfo.className = 'room-info';
            roomInfo.innerHTML = `
                       <div class="room-name">${room.roomName}</div>
                       <div style="font-size: 11px; color: #aaa; margin-top: 2px;">
                           참여자: ${room.memberCount}명
                       </div>
                   `;
            // roomInfo 클릭 시 room 객체 전체 전달
            roomInfo.onclick = () => selectRoom(room);

            // ★삭제 버튼
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-room-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteBtn.title = '채팅방 나가기';
            deleteBtn.onclick = (e) => {
                e.stopPropagation(); // 목록 선택 이벤트 방지
                if (confirm(`정말로 [${room.roomName}] 채팅방을 삭제하시겠습니까?`)) {
                    leaveChatRoom(room.roomId);
                }
            };

            // ⭐⭐ 보강: 뱃지와 삭제 버튼 컨테이너 ⭐⭐
            const actionContainer = document.createElement('div');
            actionContainer.className = 'room-item-actions';

            // 안 읽은 메시지 뱃지 추가
            if (room.unreadCount > 0) {
                actionContainer.innerHTML += `<span class="unread-badge">${room.unreadCount}</span>`;
            }
            actionContainer.appendChild(deleteBtn);
            // ⭐⭐ 보강 끝 ⭐⭐


            item.appendChild(roomInfo);
            item.appendChild(actionContainer);
            roomListContainer.appendChild(item);
        });

        // ⭐⭐ 보강: 채팅방 자동 선택 로직 제거 후, 초기 화면 메시지 표시 (유지) ⭐⭐
        if (!currentRoomId) {
            document.getElementById('current-chat-room').style.display = 'none';
            document.getElementById('chat-welcome-message').style.display = 'flex';
        }
    }

    // ★새로운 함수: 채팅방 삭제 로직
    async function leaveChatRoom(roomId) {
        if(!confirm('정말로 이 채팅방을 나가시겠습니까?')){
            return;
        }

        try {
            const token = localStorage.getItem('accessToken');

            const response = await fetch(`/chatroom/${roomId}/leave`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if(!response.ok) throw new Error('채팅방 나가기 실패')

            alert('채팅방을 나갔습니다.');

            if(currentRoomId === roomId){
                currentRoomId = null;
                document.getElementById('current-chat-room').style.display = 'none';
                document.getElementById('chat-welcome-message').style.display = 'flex';

                const leaveRoomBtn = document.getElementById('leave-room-btn');
                if(leaveRoomBtn){
                    leaveRoomBtn.style.display = 'none';
                }
            }
            loadRoomList(currentChatType);
        } catch (e){
            console.error('채팅방 나가기 실패:', e);
            alert('채팅방을 나가는데 실패했습니다.');
        }
    }

    async function loadRoomHistory(roomId) {
        chatContainer.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">메시지를 불러오는 중...</div>';

        try {
            const token = localStorage.getItem('accessToken');

            const response = await fetch(`/chatroom/${roomId}/messages`,{
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            if(!response.ok) throw new Error('메세지 조회 실패');

            const messages = await response.json();
            chatContainer.innerHTML = '';

            if(messages.length === 0){
                chatContainer.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">새로운 채팅을 시작하세요.</div>';
            } else {
                messages.forEach(msg => {
                    displayMessage({
                        sender : msg.senderNickname,
                        content : msg.content,
                        timestamp: formatTimestamp(msg.sentAt)
                    });
                });
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        } catch (e) {
            console.error('메세지 로드 실패:',e);
            chatContainer.innerHTML = '<div style="text-align:center; color:#e74c3c; padding:30px;">메시지를 불러오지 못했습니다.</div>';
        }
    }

    // ⭐⭐ 보강: selectRoom 함수 (채팅방 상태 표시 업데이트) ⭐⭐
    function selectRoom(room) {
        const activeItem = document.querySelector('.room-item.active');
        if (activeItem) {
            activeItem.classList.remove('active');
            if(participantSidebar.classList.contains('open')) {
                openParticipantList(false);
            }
        }

        // ⭐⭐⭐ 보강: 새로운 방 선택 시 인라인 프로필 창 닫기 ⭐⭐⭐
        openInlineProfileDetail(false);

        const newActiveItem = document.querySelector(`.room-item[data-room-id="${room.roomId}"]`);
        if (newActiveItem) {
            newActiveItem.classList.add('active');
            // 선택된 방의 뱃지 제거 (읽음 처리)
            const badge = newActiveItem.querySelector('.unread-badge');
            if(badge) badge.remove();
            room.unreadCount = 0;
        }

        currentRoomId = room.roomId;
        document.getElementById('sidebar-room-name').textContent = room.roomName;
        roomTitleElement.textContent = room.roomName;

        const leaveRoomBtn = document.getElementById('leave-room-btn');
        if(leaveRoomBtn){
            leaveRoomBtn.style.display = 'block';
            leaveRoomBtn.onclick = () => leaveChatRoom(room.roomId);
        }

        // 채팅방 상세 상태 업데이트 (ERD: ChatRoom 반영)
        // ⭐⭐ 보강된 채팅방 헤더 UI 업데이트 로직 ⭐⭐
        roomStatusDisplay.style.display = 'flex';
        roomParticipantCount.textContent = `${room.memberCount}`;

        let iconClass = '';
        if (currentChatType === 'one-on-one') {
            iconClass = 'fas fa-lock'; // 1:1 채팅은 잠금 아이콘
        } else {
            iconClass = 'fas fa-users'; // 그룹/전체 채팅은 사용자 아이콘
        }
        roomTypeIcon.innerHTML = `<i class="${iconClass}"></i>`;

        // 헤더에 상태 표시 요소를 DOM에 추가/정렬
        const chatHeader = document.getElementById('chat-room-header');
        if (!chatHeader.querySelector('.room-title-wrapper')) {
            const wrapper = document.createElement('div');
            wrapper.className = 'room-title-wrapper';
            wrapper.appendChild(roomTitleElement);
            wrapper.appendChild(roomStatusDisplay);
            chatHeader.prepend(wrapper);
        }
        // ⭐⭐ 보강 끝 ⭐⭐


        document.getElementById('chat-welcome-message').style.display = 'none';
        document.getElementById('current-chat-room').style.display = 'flex';
        document.getElementById('current-chat-room').style.flexDirection = 'column';

        // ⭐⭐ 보강: 채팅 내용을 로드 ⭐⭐
        loadRoomHistory(room.roomId);

        if (stompClient && stompClient.connected) {
            subscribeToRoom(room.roomId);
        } else {
            connect();
        }
    }

    function openParticipantList(shouldOpen) {
        const isOpen = typeof shouldOpen === 'boolean' ? shouldOpen : !participantSidebar.classList.contains('open');

        if (isOpen) {
            loadParticipantList(currentRoomId);
            participantSidebar.classList.add('open');
            chatMainWrapper.classList.add('sidebar-open');
            // ⭐⭐ 보강: 사이드바 열 때 인라인 프로필 창 닫기 ⭐⭐
            openInlineProfileDetail(false);
        } else {
            participantSidebar.classList.remove('open');
            chatMainWrapper.classList.remove('sidebar-open');
        }
    }

    // ★★★ 수정: 참여자 목록 로드 시 인라인 프로필 상세 창 연결 ★★★
    async function loadParticipantList(roomId) {
        participantListContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">참여자 목록을 불러오는 중...</div>';
        try{
            const token = localStorage.getItem('accessToken');

            const roomResponse = await fetch(`/chatroom/${roomId}`,{
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            const participantsResponse = await fetch(`/chatroom/${roomId}/participants`,{
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if(!roomResponse.ok || !participantsResponse.ok) throw new Error('참여자 정보 조회 실패');

            const room = await roomResponse.json();
            const participants = await participantsResponse.json();

            participantListContainer.innerHTML = '';

            if(!participants || participants.length === 0){
                participantListContainer.innerHTML = '<p style="color: #999; text-align: center; padding:20px;">참여자 정보를 찾을 수 없습니다.</p>';
                return;
            }

            document.getElementById('sidebar-room-name').textContent = `${room.roomName} (${participants.length} 명)`;

            participants.forEach(participant => {
                const item = document.createElement('div');
                item.className = 'participant-item';

                let iconClass = 'fas fa-user-circle';
                let roleBadge = '';
                const nickname = participant.nickname;
                /* 이 부분 수정해야 됨.

                if (nickname.includes('(운영진)') || nickname.includes('관리자')) {
                    iconClass = 'fas fa-shield-alt';
                    roleBadge = '<span class="participant-role-badge role-admin">운영진</span>';
                } else if (nickname.includes('(방장)')) {
                    iconClass = 'fas fa-crown';
                    roleBadge = '<span class="participant-role-badge role-host">방장</span>';
                }

                // ⭐ 본인 표시
                if (participant.userId === myUserId) {
                    roleBadge += '<span class="participant-role-badge role-me">나</span>';
                }

                 */

                const displayName = participant.replace(/\s$$.*$$/g, '');

                item.onclick = () => openInlineProfileDetail(participant.userId, displayName);

                item.innerHTML = `
                       <div class="participant-icon-wrapper">
                           <i class="${iconClass}"></i>
                       </div>
                       <div class="participant-details">
                           <span class="participant-name">${displayName}${roleBadge}</span>
                       </div>
                   `;
                participantListContainer.appendChild(item);
            });
        } catch (e) {
            console.error('참여자 목록 로드 실패:', e);
            participantListContainer.innerHTML = '<p style="color: #e74c3c; text-align: center; padding:20px;">참여자 목록을 불러오지 못했습니다.</p>';
        }
    }

    // ★★★ 최종 수정: 인라인 프로필 상세 정보 함수 (매칭내용 제거) ★★★
    async function openInlineProfileDetail(userId, displayName) {

        const isCurrentlyOpen = inlineProfileDetail.classList.contains('open');

        // 닫기 요청이거나, 이미 열려 있는 상태에서 같은 유저를 다시 클릭하면 닫기
        if (userId === false || (isCurrentlyOpen && inlineProfileDetail.dataset.username === userId)) {
            // ⭐⭐ 닫기 시 display: none으로 완전히 숨김 ⭐⭐
            inlineProfileDetail.classList.remove('open');
            inlineProfileDetail.style.display = 'none'; // 즉시 숨김
            delete inlineProfileDetail.dataset.userId;
            return;
        }

        try {
            const token = localStorage.getItem('accessToken');

            const response = await fetch(`/api/user/${userId}`,{
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if(!response.ok) throw new Error('사용자 정보 조회 실패')

            const profile = await response.json();

            inlineProfileDetail.dataset.userId = userId;

            document.getElementById('profile-img-detail').src = profile.profilePic || '/images/default-profile.png';
            document.getElementById('profile-nickname-detail').textContent = profile.nickname;
            document.getElementById('profile-location-detail').textContent = profile.location; // 장소 (지역)
            document.getElementById('profile-position-detail').textContent = profile.position;

            inlineProfileDetail.style.display = 'flex';
            inlineProfileDetail.classList.add('open');
        } catch (e) {
            console.error('프로필 조회 실패:', e);
            alert('프로필 정보를 불러올 수 없습니다.');
        }
    }

    // 새 채팅 모달 열기/닫기 (상대방 닉네임 인자 추가)
    function openNewChatModal(open, recipientUsername = null) {
        if (open) {
            newChatModal.classList.add('open');
            newChatTitleInput.value = '';
            newChatTypeSelect.value = 'one-on-one';
            updateNewChatForm('one-on-one'); // 1:1 채팅으로 설정

            // ⭐ 상대방 닉네임이 전달되었다면 input 필드에 채우기 ⭐
            if (recipientUsername) {
                newChatRecipientInput.value = recipientUsername;
            } else {
                newChatRecipientInput.value = '';
            }

            newChatTitleInput.focus();
        } else {
            newChatModal.classList.remove('open');
        }
    }


    // ★새로운 함수: 채팅방 유형에 따라 폼 필드를 업데이트
    function updateNewChatForm(type) {
        const maxParticipantsGroup = document.getElementById('max-participants-group'); // 추가된 변수

        if (type === 'one-on-one') {
            recipientInputGroup.style.display = 'block';
            maxParticipantsGroup.style.display = 'none'; // 1:1은 인원 설정 숨김
            chatFormInfo.textContent = '상대방 닉네임이 필수입니다.';
            newChatRecipientInput.placeholder = '1:1 채팅할 상대방의 닉네임을 입력하세요';

        } else if (type === 'group') {
            recipientInputGroup.style.display = 'block';
            maxParticipantsGroup.style.display = 'block'; // 그룹은 인원 설정 표시
            chatFormInfo.textContent = '그룹 채팅에 초대할 참여자 닉네임을 쉼표(,)로 입력하세요 (선택 사항).';
            newChatRecipientInput.placeholder = '초대할 닉네임 입력 (선택 사항)';

        } else if (type === 'public') {
            recipientInputGroup.style.display = 'none';
            maxParticipantsGroup.style.display = 'none'; // 전체 채팅은 인원 설정 숨김
            chatFormInfo.textContent = '전체 채팅방은 누구나 참여 가능합니다.';
        }

        // 폼 초기화 (헷갈리지 않도록)
        newChatRecipientInput.value = '';
    }

    // ★수정된 함수: 채팅방 생성 (카테고리별)
    async function createNewChat() {
        const type = newChatTypeSelect.value;
        const title = newChatTitleInput.value.trim();
        const recipientInput = newChatRecipientInput.value.trim();
        const maxParticipantsInput = document.getElementById('new-chat-max-participants'); // 추가된 변수

        if (!title) {
            alert("채팅방 제목을 입력해주세요.");
            return;
        }

        try {
            const token = localStorage.getItem('accessToken');
            let apiUrl = '';
            let requestBody = {};

            if (type === 'one-on-one') {
                if (!recipientInput) {
                    alert("1:1 채팅은 상대방 닉네임이 필수입니다.");
                    return;
                }
                const targetUserId = await fetchUserIdByNickname(recipientInput);
                apiUrl = '/chatroom/onetoone';
                requestBody = { targetUserId : targetUserId };
            } else {
                const invitedNicknames = recipientInput ? recipientInput.split(',').map(n => n.trim()) : [];
                const invitedUserIds = invitedNicknames.length > 0 ? await fetchUserIdsByNicknames(invitedNicknames) : [];
                apiUrl = '/chatroom/group';
                requestBody = {
                    roomType: type === 'public' ? 'PUBLIC' : 'group',
                    roomName: title,
                    invitedUserIds: invitedUserIds
                };

                // group 채팅인 경우 maxParticipants도 추가
                if (type === 'group') {
                    requestBody.maxParticipants = parseInt(maxParticipantsInput) || 10;
                }
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) throw new Error(`채팅방 생성 실패`);

            const newRoom = await response.json();

            openNewChatModal(false);

            // 탭 전환
            chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            const newTab = document.querySelector(`[data-type="${type}"]`);
            if (newTab) newTab.classList.add('active');

            loadRoomList(type); // 목록 갱신
            setTimeout(()=>selectRoom(newRoom),500); // 새 방으로 이동
        } catch (e) {
            console.error('채팅방 생성 실패'+e);
            alert('채팅방 생성에 실패했습니다:' + e.message);
        }
    }

    // ★수정된 함수: 프로필 모달 열기/닫기 (기존 모달이 아닌 인라인 상세 정보 창을 쓰므로, 이 함수는 사용하지 않도록 처리)
    // 인라인 상세 정보 창을 닫는 로직만 남겨둠
    function openProfileModal(username) {
        // 이 함수는 기존 모달을 닫는 역할만 수행하거나, 아예 사용하지 않도록 처리합니다.
        // 대신 openInlineProfileDetail(username)을 사용합니다.
        console.warn("openProfileModal 대신 openInlineProfileDetail을 사용하세요.");
        if (username === false) {
            const modal = document.getElementById('profile-modal');
            modal.classList.remove('open');
        }
    }


    // ===========================================
    // ★친구 초대 기능 로직★ (이전 코드에서 복구)
    // ===========================================

    /**
     * 친구 초대 모달 열기/닫기
     */
    function openInviteModal(open = true) {
        if(!currentRoomId) {
            alert('채팅방을 먼저 선택해주세요.');
            return;
        }

        if(open) {
            loadFriendListForInvite();
            inviteModal.classList.add('open');
        } else {
            inviteModal.classList.remove('open');
        }
    }

    /**
     * 초대 가능한 친구 목록을 렌더링
     */
    async function loadFriendListForInvite(currentRoom) {
        try {
            const token = localStorage.getItem('accessToken');

            const response = await fetch(`/api/friends`,{
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if(!response.ok) throw new Error('친구 목록 조회 실패');

            const friends = await response.json();
            friendListToInvite.innerHTML = '';

            friends.forEach(friend => {
                const item = document.createElement('div');
                item.className = 'invite-friend-item';
                item.innerHTML = `
                <input type="checkbox" class="friend-checkbox" value="${friend.userId}">
                <span>${friend.nickname}</span>`;
                friendListToInvite.appendChild(item);
            })
        } catch (e) {
            console.error('친구 목록 로드 실패:', e);
            friendListToInvite.innerHTML = '<p style="text-align:center; padding:20px; color:#e74c3c;">친구 목록을 불러올 수 없습니다.</p>';
        }
    }

    /**
     * 친구 선택/해제 토글 로직
     */
    function toggleInviteSelection(name, itemElement, isChecked) {
        if (isChecked) {
            if (selectedInvitees.size < availableSlots) {
                selectedInvitees.add(name);
                itemElement.classList.add('selected');
            } else {
                // 선택 제한 시 체크박스 상태 롤백
                itemElement.querySelector('.friend-checkbox').checked = false;
                alert(`최대 ${availableSlots}명까지만 초대할 수 있습니다.`);
                return;
            }
        } else {
            selectedInvitees.delete(name);
            itemElement.classList.remove('selected');
        }

        selectedInviteCountElement.textContent = selectedInvitees.size;

        // ★슬롯이 가득 찼을 때, 모든 미선택 체크박스 비활성화
        const shouldDisable = selectedInvitees.size >= availableSlots;
        document.querySelectorAll('.invite-friend-item').forEach(item => {
            const checkbox = item.querySelector('.friend-checkbox');
            if (!checkbox.checked && shouldDisable) {
                checkbox.disabled = true;
            } else {
                const friendName = item.dataset.friendName;
                const friend = MOCK_FRIENDS.find(f => f.name === friendName);
                if (friend && friend.status === '온라인') {
                    checkbox.disabled = false;
                }
            }
        });
    }

    /**
     * 최종 초대 전송 (더미 로직)
     */
    async function sendInvite() {
        const checkboxes = document.querySelectorAll('.friend-checkbox:checked');
        const invitedUserIds = Array.from(checkboxes).map(c => parseInt(c.value));

        if(invitedUserIds.length === 0) {
            alert('초대할 친구를 선택해주세요.');
            return;
        }

        try {
            const token = localStorage.getItem('accessToken');

            const response = await fetch(`/chatroom/${currentRoomId}/invite`,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ invitedUserIds:invitedUserIds })
            });

            if(!response.ok) throw new Error('초대 실패');

            alert('초대 메세지를 성공적으로 보냈습니다.');
            openInviteModal(false);
            loadParticipantList(currentRoomId);
        } catch (e) {
            console.error('초대 실패:', e);
            alert('초대에 실패했습니다.');
        }
    }
    // ===========================================
    // ★기타 이벤트 리스너 (기존 로직 유지)
    // ===========================================

    document.getElementById('room-list-container').addEventListener('click', (e) => {
        // 삭제 버튼 클릭은 여기서 처리하지 않고, deleteChatRoom에서 처리됨
    });

    chatTypeTabs.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (button) {
            chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            const newType = button.dataset.type;
            loadRoomList(newType);
        }
    });

    // ⭐⭐ 인라인 프로필 액션 버튼 핸들러 연결 ⭐⭐
    document.addEventListener('DOMContentLoaded', () => {
        initUserInfo();

        connect();

        const defaultType = 'public';

        const activeTab = document.querySelector(`[data-type="public"]`);
        if (activeTab) activeTab.classList.add('active');

        loadRoomList(defaultType);

        initEventListeners();

        if (inlineProfileDetail) {
            inlineProfileDetail.style.display = 'none';
        }
    });

    function initEventListeners() {
        const profileChatBtn = document.getElementById('profile-chat-btn');

        if (profileChatBtn) {
            profileChatBtn.addEventListener('click', async function() {
                const targetUserId = inlineProfileDetail.dataset.userId;

                if(!targetUserId) {
                    alert('사용자 정보를 불러 올 수 없습니다.');
                    return;
                }

                try {
                    const token = localStorage.getItem('accessToken');

                    const response = await fetch(`/chatroom/onetoone?targetUserId=${targetUserId}`,{
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        }
                    });

                    if(!response.ok) throw new Error('1:1 채팅창 생성 실패');

                    const chatRoom = await response.json();

                    openInlineProfileDetail(false);

                    chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    const oneToOneTab = document.querySelector(`[data-type="one-on-one"]`);

                    if(oneToOneTab) oneToOneTab.classList.add('active');

                    await loadRoomList('one-on-one');
                    setTimeout(() => selectRoom(chatRoom), 300);
                } catch (e) {
                    console.error('1:1 채팅 시작 실패:', e);
                    alert('1:1 채팅을 시작할 수 없습니다.');
                }
            });
        }

        const profileFriendBtn = document.getElementById('profile-friend-btn');

        if (profileFriendBtn) {
            profileFriendBtn.addEventListener('click', async function() {
                const targetUserId = inlineProfileDetail.dataset.userId;
                if(!targetUserId) {
                    alert('사용자 정보를 불러올 수 없습니다.');
                    return;
                }
                try {
                    const token = localStorage.getItem('accessToken');

                    const response = await fetch(`/api/friends/request/${targetUserId}`,{
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify(({ targetUserId: targetUserId}))
                    });

                    if(!response.ok) throw new Error('친구요청 실패');

                    alert('친구 요청을 보냈습니다.')
                    openInlineProfileDetail(false); // ⭐ 창 닫기 ⭐
                } catch (e) {
                    console.error('친구 요청 실패:', e);
                    alert('친구 요청을 보낼 수 없습니다.');
                }
            });
        }



        // ⭐⭐⭐ 비회원 접근 제어 로직 (채팅은 회원만 가능) ⭐⭐⭐
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert("❌ 실시간 채팅은 회원만 이용할 수 없습니다.");
            window.location.href = '/login';
            return;
        }

        const messageInput = document.getElementById('message-input');
        if (messageInput) {
            messageInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendMessage();
                }
            });
        }

        loadRoomList(currentChatType);
    }
</script>
</body>
</html>